<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live Sports ‚Äì Streams & Schedules</title>
  <meta name="description" content="Beautiful schedule UI that reads a JSON feed of live sports events and lets fans filter, search, and watch." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #0b0f16; --panel: #101522; --panel-2: #0f1420; --text: #e6ecf2; --muted: #9fb2c3;
      --brand: #7aa2ff; --brand-2: #5de2a0; --accent: #ffb86b; --danger: #ff6b6b; --ok: #32d583;
      --ring: 0 0 0 2px color-mix(in srgb, var(--brand) 35%, transparent);
      --radius: 16px; --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    /* Light theme */
    .light{
      --bg: #f6f8fb; --panel:#ffffff; --panel-2:#f3f6fb; --text:#0d1220; --muted:#5d6b7c;
      --brand:#3b82f6; --brand-2:#10b981; --accent:#f59e0b; --danger:#ef4444; --ok:#16a34a;
      --shadow: 0 6px 18px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 70% -10%, #18306b33, transparent), radial-gradient(800px 500px at -10% 10%, #20a37e22, transparent), var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .container{max-width:1200px; margin:0 auto; padding:24px}

    header{
      position: sticky; top:0; z-index:10; backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(11,15,22,.9), rgba(11,15,22,.5));
      border-bottom:1px solid #ffffff16;
    }
    .bar{display:flex; gap:14px; align-items:center; justify-content:space-between; padding:14px 24px}
    .logo{display:flex; gap:12px; align-items:center}
    .logo .mark{width:34px;height:34px;border-radius:10px; background: linear-gradient(135deg, var(--brand), #5a76ff); box-shadow: var(--shadow); position:relative}
    .logo .mark:after{content:"";position:absolute; inset:6px; border-radius:8px; background: linear-gradient(135deg, #5de2a0, #4bbf90); mix-blend-mode:screen; opacity:.7}
    .logo h1{margin:0; font-size:18px; letter-spacing:.5px}
    .date-tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{border:1px solid #ffffff1f; background: var(--panel); color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer; transition:.2s; font-weight:600}
    .tab.active, .tab:hover{border-color: color-mix(in srgb, var(--brand) 40%, transparent); box-shadow: var(--ring)}

    /* Controls */
    .controls{display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:12px; align-items:center; margin:16px 0}
    .control{position:relative}
    .control input, .control select{
      width:100%; height:44px; padding:10px 40px 10px 14px; border-radius:12px; border:1px solid #ffffff24; background:var(--panel-2); color:var(--text);
      outline:none; transition:.2s; box-shadow:none
    }
    .control input:focus, .control select:focus{border-color: color-mix(in srgb, var(--brand) 50%, transparent); box-shadow: var(--ring)}
    .control .label{font-size:12px; color:var(--muted); margin-bottom:6px; display:block}
    .chip-row{display:flex; gap:8px; flex-wrap:wrap}
    .chip{padding:6px 10px; border-radius:999px; border:1px solid #ffffff20; background:#ffffff08; font-size:12px; cursor:pointer}
    .chip.active{background:linear-gradient(135deg, #203256, #15233f); border-color:#4b6cb7}
    .toggle{display:flex; align-items:center; gap:8px; cursor:pointer; user-select:none}
    .toggle input{appearance:none;width:40px;height:24px;border-radius:999px;background:#ffffff24;position:relative;outline:none;transition:.2s}
    .toggle input:checked{background: linear-gradient(90deg, var(--brand), var(--brand-2))}
    .toggle input:before{content:""; width:18px;height:18px;border-radius:50%; background:#fff; position:absolute; top:3px; left:3px; transition:.2s}
    .toggle input:checked:before{left:19px}

    /* Grid */
    .grid{display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:16px; align-items:stretch}
    .card{background: linear-gradient(180deg, #0f1726, #0b111d); border:1px solid #ffffff14; border-radius: var(--radius); padding:16px; box-shadow: var(--shadow); display:flex; flex-direction:column; gap:12px; position:relative; overflow:hidden}
    .badge{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid #ffffff1f; color:#d7e3ff; background:#1a2440; width:max-content}
    .row{display:flex; align-items:center; justify-content:space-between; gap:12px}
    .muted{color:var(--muted)}
    .title{font-weight:800; font-size:18px}
    .sub{font-weight:600; color:#b7c8ff}
    .time{font-variant-numeric: tabular-nums}
    .countdown{font-weight:700}
    .channels{display:flex; flex-wrap:wrap; gap:8px}
    .btn{padding:10px 12px; border-radius:12px; border:1px solid #ffffff24; background:linear-gradient(135deg, #111a2b, #0d1626); color:var(--text); text-decoration:none; display:inline-flex; gap:8px; align-items:center; font-weight:600}
    .btn:hover{border-color:#4b6cb7}
    .btn.primary{background: linear-gradient(135deg, var(--brand), #5a76ff); border-color: transparent; color:#07102c}
    .btn.live{background: linear-gradient(135deg, #ff6b6b, #ff9966); color:#1b0b0b; border-color:transparent}
    .btn.small{padding:6px 10px; font-size:12px}

    .kpis{display:grid; grid-template-columns: repeat(4,1fr); gap:12px; margin:16px 0}
    .kpi{background:linear-gradient(180deg, #0f1726, #0b111d); border:1px solid #ffffff14; border-radius:14px; padding:14px}
    .kpi .n{font-size:22px; font-weight:800}
    .kpi .l{font-size:12px; color:var(--muted)}

    .empty{opacity:.7; border:1px dashed #ffffff30; padding:32px; border-radius:16px; text-align:center}

    footer{opacity:.7; padding:40px 0; text-align:center; font-size:13px}

    @media (max-width: 900px){
      .controls{grid-template-columns: 1fr 1fr}
      .kpis{grid-template-columns: repeat(2,1fr)}
      .hide-sm{display:none}
    }
  
    /* Player modal */
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.65); display:none; align-items:center; justify-content:center; z-index:50}
    .modal-backdrop.show{display:flex}
    .modal{width:min(1100px, 96vw); height:min(70vh, 80vh); background:linear-gradient(180deg,#0f1726,#0b111d); border:1px solid #ffffff24; border-radius:18px; box-shadow: var(--shadow); overflow:hidden; display:flex; flex-direction:column}
    .modal .top{display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-bottom:1px solid #ffffff14}
    .modal .top .label{font-weight:700}
    .modal .content{flex:1; background:#000}
    .modal iframe{width:100%; height:100%; border:0; display:block}
    .modal .actions{display:flex; gap:8px}
    .notice{font-size:12px; color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="bar container">
      <div class="logo">
        <div class="mark" aria-hidden="true"></div>
        <h1>Live Sports</h1>
      </div>
      <div class="date-tabs" id="dateTabs"></div>
      <button id="themeToggle" class="btn small" title="Toggle theme">üåô Theme</button>
    </div>
    <div class="container">
      <div class="controls" role="region" aria-label="Filters">
        <div class="control">
          <span class="label">Search match or team</span>
          <input id="q" type="search" placeholder="e.g., Lakers, Rangers, NFL..." autocomplete="off" />
        </div>
        <div class="control">
          <span class="label">Sport</span>
          <select id="sport"><option value="">All sports</option></select>
        </div>
        <div class="control">
          <span class="label">Tournament</span>
          <select id="tournament"><option value="">All tournaments</option></select>
        </div>
        <div class="control">
          <span class="label">Timezone</span>
          <select id="tz"></select>
        </div>
        <div class="control hide-sm">
          <span class="label">Quick filters</span>
          <div class="chip-row" id="quick"></div>
        </div>
        <div class="control">
          <span class="label">Only show</span>
          <label class="toggle"><input id="liveOnly" type="checkbox" /> <span>Live now</span></label>
        </div>
        <div class="control">
          <span class="label">Sort by</span>
          <select id="sort">
            <option value="time">Kickoff (soonest)</option>
            <option value="sport">Sport</option>
            <option value="tournament">Tournament</option>
          </select>
        </div>
        <div class="control">
          <span class="label">View</span>
          <select id="view">
            <option value="grid">Grid</option>
            <option value="timeline">Now / Next / Later</option>
            <option value="leagues">By tournament</option>
          </select>
        </div>
        <div class="control">
          <span class="label">Actions</span>
          <div class="chip-row">
            <button id="refresh" class="btn small" title="Reload JSON">‚Üª Refresh</button>
            <button id="share" class="btn small" title="Copy link with current filters">üîó Share</button>
            <button id="dlIcsFiltered" class="btn small" title="Download .ics for current list">üì• .ics (filtered)</button>
            <button id="dlIcsFav" class="btn small" title="Download .ics for favorites">‚≠ê .ics (favorites)</button>
          </div>
        </div>
        </div>
      </div>
      <div class="kpis">
        <div class="kpi"><div class="n" id="kpiTotal">‚Äì</div><div class="l">events</div></div>
        <div class="kpi"><div class="n" id="kpiLive">‚Äì</div><div class="l">live now</div></div>
        <div class="kpi"><div class="n" id="kpiSports">‚Äì</div><div class="l">sports</div></div>
        <div class="kpi"><div class="n" id="kpiTours">‚Äì</div><div class="l">tournaments</div></div>
      </div>
    </div>
  </header>

  <main class="container">
    <div id="grid" class="grid" aria-live="polite"></div>
    <div id="empty" class="empty" hidden>
      <p>No matches found. Try clearing filters or searching another team.</p>
    </div>
  </main>

  <!-- Player Modal (no sandbox) -->
  <div id="playerModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-label="Stream player">
    <div class="modal">
      <div class="top">
        <div class="label" id="playerLabel">Live Stream</div>
        <div class="actions">
          <button id="popout" class="btn small" title="Open stream in a new tab">‚Üó Pop out</button>
          <button id="closeModal" class="btn small">‚úï Close</button>
        </div>
      </div>
      <div class="content">
        <!-- Important: no sandbox & referrer unchanged -->
        <iframe id="playerFrame" allow="autoplay; fullscreen; picture-in-picture; encrypted-media" allowfullscreen referrerpolicy="strict-origin-when-cross-origin"></iframe>
      </div>
    </div>
  </div>

  <footer class="container">
    
    <div class="notice" style="margin-top:8px">Note: Streams are <strong>embeds only</strong>. Change to desktop site, if you're watching from mobile.</div>
  </footer>

  <template id="cardTpl">
    <article class="card" data-sport="" data-tournament="">
      <div class="row">
        <span class="badge sport"></span>
        <span class="badge muted tournament"></span>
      </div>
      <div class="title match"></div>
      <div class="row">
        <div>
          <div class="sub time" title="Local time">‚Äî</div>
          <div class="muted countdown">‚Äî</div>
        </div>
        <div class="chip-row">
          <a class="btn primary watch" href="#">‚ñ∂ Watch</a>
          <a class="btn small cal" target="_blank" rel="noopener" title="Add to Google Calendar">üìÖ</a>
        </div>
      </div>
      <div class="channels"></div>
    </article>
  </template>

  <script>
    const API_URL = './games_api.json'; // place the JSON file next to index.html

    const els = {
      dateTabs: document.getElementById('dateTabs'), grid: document.getElementById('grid'), empty: document.getElementById('empty'),
      q: document.getElementById('q'), sport: document.getElementById('sport'), tournament: document.getElementById('tournament'),
      liveOnly: document.getElementById('liveOnly'), sort: document.getElementById('sort'), tz: document.getElementById('tz'),
      quick: document.getElementById('quick'), refresh: document.getElementById('refresh'), share: document.getElementById('share'),
      kpiTotal: document.getElementById('kpiTotal'), kpiLive: document.getElementById('kpiLive'), kpiSports: document.getElementById('kpiSports'), kpiTours: document.getElementById('kpiTours'),
      cardTpl: document.getElementById('cardTpl'),
      // modal
      modal: document.getElementById('playerModal'), player: document.getElementById('playerFrame'), closeModal: document.getElementById('closeModal'), popout: document.getElementById('popout'), playerLabel: document.getElementById('playerLabel'),
      // ui
      themeToggle: document.getElementById('themeToggle'),
      view: document.getElementById('view'),
      dlIcsFiltered: document.getElementById('dlIcsFiltered'),
      dlIcsFav: document.getElementById('dlIcsFav')
    };

    const state = {
      raw: null, dates: [], activeDate: null, events: [], filtered: [],
      tz: Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC',
      favorites: new Set(JSON.parse(localStorage.getItem('favorites')||'[]')),
      notify: JSON.parse(localStorage.getItem('notify')||'false'),
      view: localStorage.getItem('view') || 'grid'
    };

    // --- Utils ---
    const fmt = (ts, tz) => new Intl.DateTimeFormat(undefined, {
      timeZone: tz, weekday: 'short', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
    }).format(new Date(ts * 1000));

    const toGCal = (ev, tz) => {
      const start = new Date(ev.unix_timestamp * 1000);
      const end = new Date(start.getTime() + 2 * 60 * 60 * 1000); // +2h default
      const pad = (n) => String(n).padStart(2, '0');
      const fmtCal = (d) => `${d.getUTCFullYear()}${pad(d.getUTCMonth()+1)}${pad(d.getUTCDate())}T${pad(d.getUTCHours())}${pad(d.getUTCMinutes())}${pad(d.getUTCSeconds())}Z`;
      const text = encodeURIComponent(`${ev.match} (${ev.tournament})`);
      const details = encodeURIComponent(`Watch links: ${ev.channels.join(', ')}`);
      const location = encodeURIComponent('Online');
      return `https://www.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${fmtCal(start)}/${fmtCal(end)}&details=${details}&location=${location}&ctz=${encodeURIComponent(tz)}`;
    };

    const urlParams = () => new URLSearchParams(window.location.search);
    const setQueryString = (params) => {
      const qs = new URLSearchParams(params);
      history.replaceState(null, '', `${location.pathname}?${qs.toString()}`);
    }

    // Countdown updater
    function tickCountdowns(){
      for(const el of document.querySelectorAll('[data-ts]')){
        const ts = Number(el.getAttribute('data-ts')) * 1000;
        const diff = ts - Date.now();
        if(diff <= 0){ el.textContent = 'LIVE'; el.previousElementSibling?.classList?.add('live'); continue; }
        const h = Math.floor(diff / 3_600_000);
        const m = Math.floor((diff % 3_600_000) / 60_000);
        const s = Math.floor((diff % 60_000) / 1000);
        el.textContent = `${h}h ${m}m ${s}s`;
      }
    }

    // Populate timezone select
    (function fillTZ(){
      const common = [
        state.tz,
        'UTC','America/New_York','America/Chicago','America/Denver','America/Los_Angeles','Europe/London','Europe/Berlin','Europe/Paris','Europe/Madrid','Asia/Tokyo','Asia/Dubai','Australia/Sydney'
      ];
      const uniq = [...new Set(common)];
      els.tz.innerHTML = uniq.map(z => `<option ${z===state.tz?'selected':''}>${z}</option>`).join('');
    })();

    // Quick filter chips
    const quickDefs = [
      {k:'NBA', t:'NBA'}, {k:'NFL', t:'NFL'}, {k:'NHL', t:'NHL'}, {k:'Soccer', t:'Football'}, {k:'Favorites', t:'fav'}
    ];

    function renderQuick(){
      els.quick.innerHTML = quickDefs.map(q => `<button class="chip" data-quick="${q.k}">${q.k}</button>`).join('');
      els.quick.querySelectorAll('[data-quick]').forEach(b => b.addEventListener('click', () => {
        const key = b.getAttribute('data-quick');
        if(key==='Soccer'){ els.sport.value='Football'; els.tournament.value=''; }
        else if(key==='Favorites'){ els.sport.value=''; els.tournament.value=''; els.q.value=''; els.liveOnly.checked=false; setQueryString({date: state.activeDate}); renderFavoritesOnly(); }
        else { els.tournament.value = key; els.sport.value=''; }
        if(key!=='Favorites'){ applyFilters(); }
        els.q.value='';
        els.quick.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
        b.classList.add('active');
      }));
    function renderFavoritesOnly(){
      const evs = (state.raw[state.activeDate]||[]).filter(e => state.favorites.has(makeId(e)));
      state.filtered = evs; render();
    }
        if(key==='Soccer'){ els.sport.value='Football'; } else { els.tournament.value = key; els.sport.value=''; }
        applyFilters();
        els.q.value='';
        els.quick.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
        b.classList.add('active');
      }));
    }

    // Load data
    async function load(){
      const res = await fetch(API_URL, {cache:'no-store'});
      if(!res.ok) throw new Error('Failed to load games_api.json');
      const json = await res.json();
      state.raw = json.events || {};
      state.dates = Object.keys(state.raw).sort();
      state.activeDate = urlParams().get('date') || state.dates[0] || null;
      buildDateTabs();
      hydrateLists();
      applyFilters();
      renderQuick();
    }

    function buildDateTabs(){
      els.dateTabs.innerHTML = state.dates.map(d => {
        const dt = new Date(d + 'T00:00:00Z');
        const label = dt.toLocaleDateString(undefined, {weekday:'short', month:'short', day:'numeric'});
        const active = d === state.activeDate ? 'active' : '';
        return `<button class="tab ${active}" data-date="${d}">${label}</button>`;
      }).join('');

      els.dateTabs.querySelectorAll('[data-date]').forEach(b => b.addEventListener('click', () => {
        state.activeDate = b.getAttribute('data-date');
        setQueryString({date: state.activeDate});
        els.dateTabs.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        b.classList.add('active');
        applyFilters();
      }));
    }

    function hydrateLists(){
      const evs = (state.raw[state.activeDate] || []);
      state.events = evs.map(e => ({...e}));
      const sports = [...new Set(state.events.map(e=>e.sport))].sort();
      const tours = [...new Set(state.events.map(e=>e.tournament))].sort();
      els.sport.innerHTML = '<option value="">All sports</option>' + sports.map(s=>`<option>${s}</option>`).join('');
      els.tournament.innerHTML = '<option value="">All tournaments</option>' + tours.map(t=>`<option>${t}</option>`).join('');
      // KPIs
      els.kpiTotal.textContent = state.events.length;
      els.kpiSports.textContent = sports.length;
      els.kpiTours.textContent = tours.length;
    }

    function applyFilters(){
      const q = els.q.value.trim().toLowerCase();
      const sport = els.sport.value;
      const tour = els.tournament.value;
      const liveOnly = els.liveOnly.checked;
      let list = (state.raw[state.activeDate] || []).slice();
      list = list.filter(ev => {
        const t = String(ev.match + ' ' + ev.tournament + ' ' + ev.sport).toLowerCase();
        if(q && !t.includes(q)) return false;
        if(sport && ev.sport !== sport) return false;
        if(tour && ev.tournament !== tour) return false;
        if(liveOnly){
          const now = Date.now()/1000; // live: kickoff..+3h
          if(!(ev.unix_timestamp <= now && now <= ev.unix_timestamp + 3*3600)) return false;
        }
        return true;
      });
      const sortBy = els.sort.value;
      list.sort((a,b)=>{
        if(sortBy==='time') return a.unix_timestamp - b.unix_timestamp;
        if(sortBy==='sport') return a.sport.localeCompare(b.sport) || a.unix_timestamp - b.unix_timestamp;
        if(sortBy==='tournament') return a.tournament.localeCompare(b.tournament) || a.unix_timestamp - b.unix_timestamp;
        return 0;
      });
      state.filtered = list;
      els.kpiLive.textContent = list.filter(ev=> Date.now()/1000 >= ev.unix_timestamp && Date.now()/1000 <= ev.unix_timestamp + 3*3600).length;
      render();
    }

    function render(){
      const mode = state.view;
      if(mode==='timeline') return renderTimeline();
      if(mode==='leagues') return renderByLeague();
      return renderGrid();
    }

    function renderGrid(){
      const list = state.filtered;
      els.grid.innerHTML = '';
      els.empty.hidden = list.length !== 0;
      for(const ev of list){
        const id = makeId(ev);
        const node = els.cardTpl.content.firstElementChild.cloneNode(true);
        node.dataset.sport = ev.sport; node.dataset.tournament = ev.tournament;
        node.querySelector('.sport').textContent = ev.sport;
        node.querySelector('.tournament').textContent = ev.tournament;
        node.querySelector('.match').textContent = ev.match;
        node.querySelector('.time').textContent = fmt(ev.unix_timestamp, els.tz.value || state.tz);
        const cdown = node.querySelector('.countdown'); cdown.setAttribute('data-ts', ev.unix_timestamp);
        const watchBtn = node.querySelector('.watch');
        watchBtn.addEventListener('click', (e)=>{ e.preventDefault(); openPlayer(ev.channels[0], ev.match); });
        node.querySelector('.cal').href = toGCal(ev, els.tz.value || state.tz);
        const ch = node.querySelector('.channels');
        ch.innerHTML = ev.channels.map((u,i)=> `<a class=\"btn small ch\" href=\"#\" data-url=\"${u}\">Link ${i+1}</a>`).join('');
        // fav + notify
        const chRow = ch;
        const fav = document.createElement('button'); fav.className='btn small fav'; fav.dataset.id = id; fav.textContent = state.favorites.has(id) ? '‚≠ê Favorited' : '‚òÜ Favorite';
        fav.addEventListener('click', (e)=>{ e.preventDefault(); toggleFav(id); fav.textContent = state.favorites.has(id) ? '‚≠ê Favorited' : '‚òÜ Favorite'; });
        const bell = document.createElement('button'); bell.className='btn small'; bell.textContent='üîî Notify'; bell.title='Remind me 5 min before kickoff (while this tab is open)';
        bell.addEventListener('click', (e)=>{ e.preventDefault(); scheduleReminder(ev); bell.textContent='‚úÖ Scheduled'; setTimeout(()=> bell.textContent='üîî Notify', 1500); });
        chRow.prepend(bell); chRow.prepend(fav);
        els.grid.appendChild(node);
      }
      tickCountdowns();
    }

    function renderTimeline(){
      const now = Date.now()/1000;
      const list = state.filtered;
      const buckets = { now: [], next: [], later: [] };
      for(const ev of list){
        if(ev.unix_timestamp <= now && now <= ev.unix_timestamp + 3*3600) buckets.now.push(ev);
        else if(ev.unix_timestamp > now && ev.unix_timestamp <= now + 2*3600) buckets.next.push(ev);
        else buckets.later.push(ev);
      }
      const sections = [
        ['NOW', buckets.now], ['NEXT (‚â§ 2h)', buckets.next], ['LATER', buckets.later]
      ];
      els.grid.innerHTML = sections.map(([label, arr])=>{
        if(arr.length===0) return '';
        const items = arr.map(ev=>{
          const when = fmt(ev.unix_timestamp, els.tz.value || state.tz);
          return `<div class=\"card\"><div class=\"row\"><span class=\"badge sport\">${ev.sport}</span><span class=\"badge muted\">${e

    // Debounced search
    let t; els.q.addEventListener('input', ()=>{ clearTimeout(t); t=setTimeout(applyFilters, 120); });
    [els.sport, els.tournament, els.liveOnly, els.sort].forEach(el=> el.addEventListener('change', applyFilters));
    els.tz.addEventListener('change', ()=>{ applyFilters(); });
    // Theme toggle
    els.themeToggle.addEventListener('click', ()=>{
      document.documentElement.classList.toggle('light');
      localStorage.setItem('theme', document.documentElement.classList.contains('light') ? 'light' : 'dark');
    });('change', ()=>{ applyFilters(); });

    els.refresh.addEventListener('click', ()=> load().catch(err => alert(err.message)) );
    els.share.addEventListener('click', ()=>{
      const params = new URLSearchParams({
        date: state.activeDate || '',
        q: els.q.value || '',
        sport: els.sport.value || '',
        tournament: els.tournament.value || '',
        live: els.liveOnly.checked ? '1' : '',
        sort: els.sort.value || '',
        tz: els.tz.value || ''
      });
      const link = `${location.origin}${location.pathname}?${params}`;
      navigator.clipboard.writeText(link).then(()=>{
        els.share.textContent = '‚úÖ Copied!'; setTimeout(()=> els.share.textContent='üîó Share', 1200);
      });
    });

    // Grid delegate for channel buttons
    els.grid.addEventListener('click', (e)=>{
      const a = e.target.closest('a.ch');
      if(!a) return;
      e.preventDefault();
      const url = a.getAttribute('data-url');
      const title = a.closest('.card').querySelector('.match')?.textContent || 'Live Stream';
      openPlayer(url, title);
    });
    els.share.addEventListener('click', ()=>{
      const params = new URLSearchParams({
        date: state.activeDate || '',
        q: els.q.value || '',
        sport: els.sport.value || '',
        tournament: els.tournament.value || '',
        live: els.liveOnly.checked ? '1' : '',
        sort: els.sort.value || '',
        tz: els.tz.value || ''
      });
      const link = `${location.origin}${location.pathname}?${params}`;
      navigator.clipboard.writeText(link).then(()=>{
        els.share.textContent = '‚úÖ Copied!'; setTimeout(()=> els.share.textContent='üîó Share', 1200);
      });
    });

    // Restore from URL on load
    function restoreFromQS(){
      const p = urlParams();
      if(p.get('q')) els.q.value = p.get('q');
      if(p.get('sport')) els.sport.value = p.get('sport');
      if(p.get('tournament')) els.tournament.value = p.get('tournament');
      if(p.get('live')) els.liveOnly.checked = p.get('live')==='1';
      if(p.get('sort')) els.sort.value = p.get('sort');
      if(p.get('tz')) els.tz.value = p.get('tz');
    }

    // Poll countdowns every second
    setInterval(tickCountdowns, 1000);
    // Auto-refresh data every 2 minutes (useful on match days)
    setInterval(()=>{ if(state.activeDate){ load().catch(()=>{}); } }, 120000);

    // Player controls (no sandbox; keep default referrer)
    function openPlayer(url, title='Live Stream'){
      if(!url) return;
      els.player.src = url; // embeds only ‚Äì do not open directly
      els.playerLabel.textContent = title;
      els.modal.classList.add('show');
      els.modal.setAttribute('aria-hidden','false');
      document.body.style.overflow='hidden';
      els.popout.onclick = () => { window.open(url, '_blank'); };
    }
    function closePlayer(){
      els.modal.classList.remove('show');
      els.modal.setAttribute('aria-hidden','true');
      document.body.style.overflow='';
      els.player.src = '';
    }
    els.closeModal.addEventListener('click', closePlayer);
    els.modal.addEventListener('click', (e)=>{ if(e.target === els.modal) closePlayer(); });
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && els.modal.classList.contains('show')) closePlayer(); });

    // helpers for ids & storage
    const makeId = (ev) => ev.id || `${ev.match}|${ev.unix_timestamp}`;
    function toggleFav(id){
      if(state.favorites.has(id)) state.favorites.delete(id); else state.favorites.add(id);
      localStorage.setItem('favorites', JSON.stringify([...state.favorites]));
    }
    function scheduleReminder(ev){
      const show = () => {
        try{ new Notification(`${ev.match} starting`, { body: `${ev.tournament} ‚Ä¢ in 5 minutes`, tag: makeId(ev) }); }catch(_){}
      };
      const ms = (ev.unix_timestamp*1000) - Date.now() - 5*60*1000;
      if(ms <= 0) { show(); return; }
      if(Notification && Notification.permission !== 'granted'){
        Notification.requestPermission().then(p=>{ if(p==='granted') setTimeout(show, ms); });
      } else { setTimeout(show, ms); }
    }
    // Restore theme
    if(localStorage.getItem('theme')==='light') document.documentElement.classList.add('light');

    restoreFromQS();
    load().catch(err => {
      console.error(err);
      els.grid.innerHTML = `<div class="empty">‚ö†Ô∏è ${err.message}. Make sure <code>games_api.json</code> is present.</div>`;
    });
  </script>
</body>
</html>
